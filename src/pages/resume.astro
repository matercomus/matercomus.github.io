---
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import fs from 'fs';
import path from 'path';

// Read CV HTML files
const cvEnPath = path.join(process.cwd(), 'public', 'cv', 'index.html');
const cvZhPath = path.join(process.cwd(), 'public', 'cv', 'index.zh.html');

let cvEnContent = '';
let cvZhContent = '';

try {
	cvEnContent = fs.readFileSync(cvEnPath, 'utf-8');
	// Extract body content (everything between <body> and </body>)
	const bodyMatch = cvEnContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
	if (bodyMatch) {
		cvEnContent = bodyMatch[1];
	}
} catch (e) {
	console.error('Error reading English CV:', e);
}

try {
	cvZhContent = fs.readFileSync(cvZhPath, 'utf-8');
	// Extract body content
	const bodyMatch = cvZhContent.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
	if (bodyMatch) {
		cvZhContent = bodyMatch[1];
	}
} catch (e) {
	console.error('Error reading Chinese CV:', e);
}
---

<BaseLayout title={`Resume - ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
	<section class="py-8 sm:py-16">
		<div class="container px-4 sm:px-6 space-y-6 mb-6">
			<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
				<h1 class="scroll-m-20 text-3xl sm:text-4xl font-extrabold tracking-tight">Resume</h1>
				<div class="flex flex-wrap items-center gap-2">
					<div class="flex gap-2" id="language-switcher">
						<button 
							data-lang="en"
							class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-primary text-primary-foreground shadow hover:bg-primary/90"
						>
							English
						</button>
						<button 
							data-lang="zh"
							class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-secondary text-foreground shadow-sm hover:bg-secondary/80"
						>
							中文
						</button>
					</div>
					<button 
						id="print-button"
						class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-outline border border-input bg-background text-foreground shadow-sm hover:bg-accent hover:text-accent-foreground inline-flex items-center gap-2"
					>
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
							<polyline points="7 10 12 15 17 10"></polyline>
							<line x1="12" y1="15" x2="12" y2="3"></line>
						</svg>
						<span class="hidden sm:inline">Print / Save PDF</span>
						<span class="sm:hidden">PDF</span>
					</button>
				</div>
			</div>
		</div>
		
		<!-- CV Content Container -->
		<div class="w-full bg-white">
			<!-- English CV -->
			<div id="cv-en" class="cv-content">
				<div class="mx-auto py-10 px-6" set:html={cvEnContent}></div>
			</div>
			
			<!-- Chinese CV -->
			<div id="cv-zh" class="cv-content hidden">
				<div class="mx-auto py-10 px-6" set:html={cvZhContent}></div>
			</div>
		</div>
	</section>

	<!-- Include Font Awesome and CV styles -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
	<link rel="stylesheet" crossorigin href="/cv/assets/style-D2WWScph.css"/>
	
	<style>
		/* Fix button styling - ensure buttons don't look like links */
		#language-switcher button,
		#print-button {
			text-decoration: none !important;
			cursor: pointer;
			appearance: none;
			-webkit-appearance: none;
		}
		
		/* A4 width: 210mm = 8.27in = ~794px at 96dpi, but we'll use a more readable width */
		.cv-content {
			font-family: system-ui, -apple-system, sans-serif;
			max-width: 794px; /* A4 width in pixels at 96dpi */
			margin: 0 auto;
		}
		
		.cv-content > div {
			max-width: 100%;
		}
		
		.cv-content img {
			max-width: 100%;
			height: auto;
		}
		
		@media print {
			.cv-content.hidden {
				display: none !important;
			}
		}
		
		@media (max-width: 820px) {
			.cv-content {
				max-width: 100%;
				padding: 0 1rem;
			}
		}
	</style>

	<script>
		const switcher = document.getElementById('language-switcher');
		const printButton = document.getElementById('print-button');
		const cvEn = document.getElementById('cv-en');
		const cvZh = document.getElementById('cv-zh');
		const buttons = switcher?.querySelectorAll('button');

		let currentLang = 'en';

		function printCV() {
			// Open the CV in a new window for printing
			const cvUrl = currentLang === 'zh' ? '/cv/index.zh.html' : '/cv/index.html';
			const printWindow = window.open(cvUrl, '_blank');
			if (printWindow) {
				printWindow.onload = () => {
					printWindow.print();
				};
			}
		}

		function switchLanguage(lang) {
			currentLang = lang;
			
			if (lang === 'zh') {
				cvEn?.classList.add('hidden');
				cvZh?.classList.remove('hidden');
			} else {
				cvEn?.classList.remove('hidden');
				cvZh?.classList.add('hidden');
			}

			// Update button styles
			buttons?.forEach(btn => {
				const btnLang = btn.getAttribute('data-lang');
				if (btnLang === lang) {
					btn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors bg-primary text-primary-foreground shadow hover:bg-primary/90';
				} else {
					btn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors bg-secondary text-foreground shadow-sm hover:bg-secondary/80';
				}
			});
		}

		// Attach print button event listener
		if (printButton) {
			printButton.addEventListener('click', printCV);
		}

		// Attach language switcher event listeners
		if (switcher && buttons) {
			buttons.forEach(button => {
				button.addEventListener('click', () => {
					const lang = button.getAttribute('data-lang');
					if (lang) {
						switchLanguage(lang);
					}
				});
			});
		}
	</script>
</BaseLayout>
