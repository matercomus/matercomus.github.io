---
import { getCollection, render } from 'astro:content';
import CVLayout from '../layouts/CVLayout.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

// Load CV content
const cvEntries = await getCollection('cv');
const cvEn = cvEntries.find(entry => entry.data.language === 'en');
const cvZh = cvEntries.find(entry => entry.data.language === 'zh');

let ContentEn = null;
let ContentZh = null;

if (cvEn) {
	const { Content } = await render(cvEn);
	ContentEn = Content;
}

if (cvZh) {
	const { Content } = await render(cvZh);
	ContentZh = Content;
}
---

<CVLayout title={`Resume - ${SITE_TITLE}`}>
	<section class="py-8 sm:py-16">
		<div class="container px-4 sm:px-6 space-y-6 mb-6">
			<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
				<h1 class="scroll-m-20 text-3xl sm:text-4xl font-extrabold tracking-tight">Resume</h1>
				<div class="flex flex-wrap items-center gap-2">
					<div class="flex gap-2" id="language-switcher">
						<button 
							data-lang="en"
							class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2"
						>
							English
						</button>
						<button 
							data-lang="zh"
							class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring bg-secondary text-foreground shadow-sm hover:bg-secondary/80 h-9 px-4 py-2"
						>
							中文
						</button>
					</div>
					<button 
						id="print-button"
						class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring border border-input bg-background text-foreground shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
					>
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
							<polyline points="7 10 12 15 17 10"></polyline>
							<line x1="12" y1="15" x2="12" y2="3"></line>
						</svg>
						<span class="hidden sm:inline">Print / Save PDF</span>
						<span class="sm:hidden">PDF</span>
					</button>
				</div>
			</div>
		</div>
		
		<!-- CV Content Container -->
		<div class="w-full bg-white">
			<!-- English CV -->
			{ContentEn && (
				<div id="cv-en" class="cv-content">
					<ContentEn />
				</div>
			)}
			
			<!-- Chinese CV -->
			{ContentZh && (
				<div id="cv-zh" class="cv-content hidden">
					<ContentZh />
				</div>
			)}
		</div>
	</section>

	<script>
		const switcher = document.getElementById('language-switcher');
		const printButton = document.getElementById('print-button');
		const cvEn = document.getElementById('cv-en');
		const cvZh = document.getElementById('cv-zh');
		const buttons = switcher?.querySelectorAll('button');

		let currentLang = 'en';

		function printCV() {
			// Trigger browser print dialog (same as Ctrl+P)
			window.print();
		}

		function switchLanguage(lang) {
			currentLang = lang;
			
			if (lang === 'zh') {
				cvEn?.classList.add('hidden');
				cvZh?.classList.remove('hidden');
			} else {
				cvEn?.classList.remove('hidden');
				cvZh?.classList.add('hidden');
			}

			// Update button styles
			buttons?.forEach(btn => {
				const btnLang = btn.getAttribute('data-lang');
				if (btnLang === lang) {
					btn.className = 'inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2';
				} else {
					btn.className = 'inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring bg-secondary text-foreground shadow-sm hover:bg-secondary/80 h-9 px-4 py-2';
				}
			});
		}

		// Attach print button event listener
		if (printButton) {
			printButton.addEventListener('click', printCV);
		}

		// Attach language switcher event listeners
		if (switcher && buttons) {
			buttons.forEach(button => {
				button.addEventListener('click', () => {
					const lang = button.getAttribute('data-lang');
					if (lang) {
						switchLanguage(lang);
					}
				});
			});
		}
	</script>
</CVLayout>
